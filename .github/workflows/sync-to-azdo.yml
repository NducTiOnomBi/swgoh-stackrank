name: Sync characterBaseData.json to Azure DevOps

permissions:
    contents: read

concurrency:
    group: sync-azdo-main
    cancel-in-progress: false

on:
    workflow_dispatch:
    push:
        branches: [main]
        paths:
            - "Data/characterBaseData.json"

jobs:
    sync:
        runs-on: ubuntu-latest
        timeout-minutes: 25

        env:
            AZDO_ORG: ${{ secrets.AZDO_ORG }}
            AZDO_PROJECT: ${{ secrets.AZDO_PROJECT }}
            AZDO_REPO: ${{ secrets.AZDO_REPO }}
            AZDO_DEST_PATH: swgoh-stackrank-webapp/swgoh-stackrank-webapp/Data/characterBaseData.json

        steps:
            - name: Checkout GitHub repo
              uses: actions/checkout@v4

            - name: Validate and mask secrets
              env:
                  AZDO_PAT: ${{ secrets.AZDO_PAT }}
              run: |
                  set -euo pipefail

                  echo "::group::Pre-sync Validation"

                  # Mask PAT to prevent accidental exposure in logs
                  echo "::add-mask::$AZDO_PAT"

                  # Validate JSON syntax
                  if ! jq empty Data/characterBaseData.json; then
                    echo "::error::Invalid JSON syntax in characterBaseData.json"
                    exit 1
                  fi

                  echo "✓ JSON validation passed"
                  echo "::endgroup::"

            - name: Configure Git
              run: |
                  git config --global user.name "${GITHUB_ACTOR}"
                  git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

            - name: Clone Azure DevOps dev branch
              env:
                  AZDO_PAT: ${{ secrets.AZDO_PAT }}
              run: |
                  set -euo pipefail
                  git clone \
                    --branch dev \
                    https://:${AZDO_PAT}@dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_git/${AZDO_REPO} \
                    azdo

            - name: Copy file into AzDO repo
              run: |
                  set -euo pipefail
                  cp Data/characterBaseData.json azdo/${AZDO_DEST_PATH}

            - name: Commit to AzDO
              id: commit
              env:
                  AZDO_PAT: ${{ secrets.AZDO_PAT }}
              run: |
                  set -euo pipefail

                  echo "::group::Commit and Push to Azure DevOps"

                  cd azdo
                  git add ${AZDO_DEST_PATH}

                  if git diff-index --quiet HEAD; then
                    echo "no_changes=true" >> $GITHUB_OUTPUT
                    echo "No changes to commit"
                    echo "::endgroup::"
                    exit 0
                  fi

                  git commit -m "Sync from GitHub commit $GITHUB_SHA by $GITHUB_ACTOR"

                  # Explicitly check git push exit code
                  if ! git push origin dev; then
                    echo "::error::Git push to Azure DevOps failed"
                    exit 1
                  fi

                  echo "✓ Successfully pushed to Azure DevOps dev branch"
                  echo "no_changes=false" >> $GITHUB_OUTPUT
                  echo "::endgroup::"

            # ---------------------------
            # Poll Azure DevOps Build Pipeline
            # ---------------------------
            - name: Poll AzDO Build Pipeline
              id: poll_build
              # if: steps.commit.outputs.no_changes == 'false'
              env:
                  AZDO_PAT: ${{ secrets.AZDO_PAT }}
              run: |
                  set -euo pipefail

                  echo "::group::Build Pipeline Polling"

                  # Wait 10 seconds for Azure DevOps to trigger build (mitigates race condition)
                  echo "Waiting 10 seconds for build to start..."
                  sleep 10

                  MAX_RETRIES=30  # 30 retries × 15 seconds = 7.5 minutes
                  SLEEP=15
                  SOURCE_SHA="${{ github.sha }}"
                  BUILD_DEFINITION_ID=2

                  echo "Polling for build triggered after push (GitHub commit: $SOURCE_SHA)"

                  # Get timestamp of when we pushed (for filtering builds)
                  PUSH_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                  echo "Push completed at: $PUSH_TIME"

                  for i in $(seq 1 $MAX_RETRIES); do
                    echo "Attempt $i/$MAX_RETRIES..."
                    
                    # Query builds filtered by definition ID and branch, ordered by queue time descending
                    RESULT=$(curl -s -u ":$AZDO_PAT" \
                      "https://dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_apis/build/builds?definitions=${BUILD_DEFINITION_ID}&branchName=refs/heads/dev&queryOrder=queueTimeDescending&api-version=7.1-preview.7")
                    
                    # Get the most recent build (first in the list)
                    BUILD_ID=$(echo "$RESULT" | jq -r '.value[0].id // empty')
                    
                    if [[ -n "$BUILD_ID" ]]; then
                      STATUS=$(echo "$RESULT" | jq -r '.value[0].status // empty')
                      RESULT_TEXT=$(echo "$RESULT" | jq -r '.value[0].result // empty')
                      SOURCE_VERSION=$(echo "$RESULT" | jq -r '.value[0].sourceVersion // empty')
                      QUEUE_TIME=$(echo "$RESULT" | jq -r '.value[0].queueTime // empty')
                      
                      echo "Build ID: $BUILD_ID | Status: $STATUS | Result: $RESULT_TEXT"
                      echo "  Queue Time: $QUEUE_TIME | Source Version: $SOURCE_VERSION"
                      
                      if [[ "$STATUS" == "completed" ]]; then
                        if [[ "$RESULT_TEXT" == "succeeded" ]]; then
                          echo "✓ Build completed successfully"
                          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
                          echo "::endgroup::"
                          exit 0
                        else
                          echo "::error::Build completed with result: $RESULT_TEXT"
                          echo "::error::View build at: https://dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_build/results?buildId=${BUILD_ID}"
                          exit 1
                        fi
                      fi
                    else
                      echo "No builds found yet for definition $BUILD_DEFINITION_ID on dev branch"
                    fi
                    
                    echo "Sleeping $SLEEP seconds..."
                    sleep $SLEEP
                  done

                  echo "::error::Timed out waiting for build to complete after $((MAX_RETRIES * SLEEP)) seconds"
                  echo "::error::Check Azure DevOps at: https://dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_build"
                  exit 1

            # ---------------------------
            # Poll Azure DevOps Release Pipeline
            # ---------------------------
            - name: Poll AzDO Release Pipeline
              id: poll_release
              #if: steps.commit.outputs.no_changes == 'false'
              env:
                  AZDO_PAT: ${{ secrets.AZDO_PAT }}
              run: |
                  set -euo pipefail

                  echo "::group::Release Pipeline Polling"

                  BUILD_ID="${{ steps.poll_build.outputs.build_id }}"
                  MAX_RETRIES=40  # 40 retries × 15 seconds = 10 minutes
                  SLEEP=15

                  echo "Polling for release triggered by build ID: $BUILD_ID"

                  for i in $(seq 1 $MAX_RETRIES); do
                    echo "Attempt $i/$MAX_RETRIES..."
                    
                    # Query releases filtered by build artifact version ID
                    RESULT=$(curl -s -u ":$AZDO_PAT" \
                      "https://vsrm.dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_apis/release/releases?\$expand=environments&artifactVersionId=${BUILD_ID}&api-version=7.1-preview")
                    
                    # Get the most recent release for this build
                    RELEASE_ID=$(echo "$RESULT" | jq -r '.value[0].id // empty')
                    
                    if [[ -n "$RELEASE_ID" ]]; then
                      echo "Release ID: $RELEASE_ID"
                      
                      # Check all environment statuses
                      ENV_STATUSES=$(echo "$RESULT" | jq -r '.value[0].environments[].status')
                      
                      # Check if all environments succeeded
                      ALL_SUCCEEDED=true
                      ANY_FAILED=false
                      
                      while IFS= read -r status; do
                        echo "  Environment status: $status"
                        
                        if [[ "$status" != "succeeded" ]]; then
                          ALL_SUCCEEDED=false
                        fi
                        
                        if [[ "$status" == "failed" ]]; then
                          ANY_FAILED=true
                        fi
                      done <<< "$ENV_STATUSES"
                      
                      if [[ "$ANY_FAILED" == "true" ]]; then
                        echo "::error::Deployment failed"
                        echo "::error::View release at: https://vsrm.dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_releaseProgress?releaseId=${RELEASE_ID}"
                        exit 1
                      fi
                      
                      if [[ "$ALL_SUCCEEDED" == "true" ]]; then
                        echo "✓ All deployments completed successfully"
                        echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
                        echo "::endgroup::"
                        exit 0
                      fi
                      
                      echo "Deployments still in progress..."
                    else
                      echo "Release not found yet for build $BUILD_ID"
                    fi
                    
                    echo "Sleeping $SLEEP seconds..."
                    sleep $SLEEP
                  done

                  echo "::error::Timed out waiting for release to complete after $((MAX_RETRIES * SLEEP)) seconds"
                  echo "::error::Check Azure DevOps at: https://vsrm.dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_release"
                  exit 1

            # ---------------------------
            # Notify GitHub Author
            # ---------------------------
            - name: Notify GitHub commit author - Success
              if: steps.commit.outputs.no_changes == 'false' && success()
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  BUILD_ID="${{ steps.poll_build.outputs.build_id }}"
                  RELEASE_ID="${{ steps.poll_release.outputs.release_id }}"

                  BUILD_URL="https://dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_build/results?buildId=${BUILD_ID}"
                  RELEASE_URL="https://vsrm.dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_releaseProgress?releaseId=${RELEASE_ID}"

                  COMMENT="✅ **Build and Deployment Succeeded**

                  Your update to \`characterBaseData.json\` has been successfully deployed to the DEV environment.

                  **Build Details:**
                  - Build ID: [${BUILD_ID}](${BUILD_URL})
                  - Release ID: [${RELEASE_ID}](${RELEASE_URL})

                  **Next Steps:**
                  - Visit https://dev-swgoh-stackrank-westus.azurewebsites.net/stackrank to validate your changes
                  - After validation, changes can be promoted to production"

                  curl -X POST \
                    -H "Authorization: Bearer $GH_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
                    -d "{\"body\": $(echo "$COMMENT" | jq -Rs .)}"

            - name: Notify GitHub commit author - Failure
              if: steps.commit.outputs.no_changes == 'false' && failure()
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  BUILD_ID="${{ steps.poll_build.outputs.build_id }}"
                  RELEASE_ID="${{ steps.poll_release.outputs.release_id }}"

                  COMMENT="❌ **Build or Deployment Failed**

                  Your update to \`characterBaseData.json\` encountered an error during the build or deployment process.

                  **Troubleshooting:**"

                  if [[ -n "$BUILD_ID" ]]; then
                    BUILD_URL="https://dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_build/results?buildId=${BUILD_ID}"
                    COMMENT="$COMMENT
                  - View build logs: [Build ${BUILD_ID}](${BUILD_URL})"
                  fi

                  if [[ -n "$RELEASE_ID" ]]; then
                    RELEASE_URL="https://vsrm.dev.azure.com/${AZDO_ORG}/${AZDO_PROJECT}/_releaseProgress?releaseId=${RELEASE_ID}"
                    COMMENT="$COMMENT
                  - View release logs: [Release ${RELEASE_ID}](${RELEASE_URL})"
                  fi

                  COMMENT="$COMMENT
                  - Check Azure DevOps for detailed error messages
                  - Verify the characterBaseData.json changes are valid
                  - Contact the repository maintainer if the issue persists"

                  curl -X POST \
                    -H "Authorization: Bearer $GH_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
                    -d "{\"body\": $(echo "$COMMENT" | jq -Rs .)}"

            - name: Notify GitHub for no changes
              if: steps.commit.outputs.no_changes == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  COMMENT="ℹ️ No changes to characterBaseData.json — nothing to deploy."
                  curl -X POST \
                    -H "Authorization: Bearer $GH_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
                    -d "{\"body\": \"$COMMENT\"}"
