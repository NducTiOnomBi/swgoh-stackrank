name: Sync characterBaseData.json to Azure DevOps

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "Data/characterBaseData.json"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout GitHub repo
      uses: actions/checkout@v4

    - name: Configure Git
      run: |
        git config --global user.name "${GITHUB_ACTOR}"
        git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

    - name: Clone Azure DevOps dev branch
      env:
        AZDO_PAT: ${{ secrets.AZDO_PAT }}
      run: |
        git clone \
          --branch dev \
          https://:${AZDO_PAT}@dev.azure.com/${{ secrets.AZDO_ORG }}/${{ secrets.AZDO_PROJECT }}/_git/${{ secrets.AZDO_REPO }} \
          azdo

    - name: Copy file into AzDO repo
      run: |
        cp Data/characterBaseData.json azdo/swgoh-stackrank-webapp/swgoh-stackrank-webapp/Data/characterBaseData.json

    - name: Commit to AzDO
      id: commit
      env:
        AZDO_PAT: ${{ secrets.AZDO_PAT }}
      run: |
        cd azdo
        git add swgoh-stackrank-webapp/swgoh-stackrank-webapp/Data/characterBaseData.json
    
        if git diff-index --quiet HEAD; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
          echo "No changes to commit"
          exit 0
        fi
    
        git commit -m "Sync from GitHub commit $GITHUB_SHA by $GITHUB_ACTOR"
        git push origin dev
        echo "no_changes=false" >> $GITHUB_OUTPUT

    # ---------------------------
    # Poll Azure DevOps Pipeline
    # ---------------------------
    - name: Poll AzDO pipeline
      id: poll
      # if: steps.commit.outputs.no_changes == 'false'
      env:
        AZDO_PAT: ${{ secrets.AZDO_PAT }}
        AZDO_ORG: ${{ secrets.AZDO_ORG }}
        AZDO_PROJECT: ${{ secrets.AZDO_PROJECT }}
      run: |
        echo "Polling Azure DevOps build for dev branch..."
        MAX_RETRIES=30
        SLEEP=15
        BUILD_ID=""
        for i in $(seq 1 $MAX_RETRIES); do
          echo "Attempt $i..."
          
          RESULT=$(curl -s -u ":$AZDO_PAT" \
            "https://dev.azure.com/$AZDO_ORG/$AZDO_PROJECT/_apis/build/builds?branchName=refs/heads/dev&api-version=7.1-preview.7")
    
          echo "Raw response: $RESULT"
    
          BUILD_ID=$(echo "$RESULT" | jq -r '.value[0].id // empty')
          STATUS=$(echo "$RESULT" | jq -r '.value[0].status // empty')
          RESULT_TEXT=$(echo "$RESULT" | jq -r '.value[0].result // empty')
    
          if [[ -n "$BUILD_ID" ]]; then
            echo "Build ID: $BUILD_ID Status: $STATUS Result: $RESULT_TEXT"
            if [[ "$STATUS" == "completed" ]]; then
              echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
              echo "build_result=$RESULT_TEXT" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
    
          echo "Build not completed yet. Sleeping $SLEEP seconds..."
          sleep $SLEEP
        done
    
        echo "Timed out waiting for build to complete"
        exit 1


    # ---------------------------
    # Notify GitHub Author
    # ---------------------------
    - name: Notify GitHub commit author
      if: steps.commit.outputs.no_changes == 'false'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        COMMENT="Your update to characterBaseData.json has been deployed to the DEV environment in Azure from Build ID ${{ steps.poll.outputs.build_id }}."
        curl -X POST \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
          -d "{\"body\": \"$COMMENT\"}"
    
    - name: Notify GitHub for no changes
      if: steps.commit.outputs.no_changes == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        COMMENT="No changes to characterBaseData.json â€” nothing to deploy."
        curl -X POST \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
          -d "{\"body\": \"$COMMENT\"}"

